/**
  ******************************************************************************
  * @file    subsystems/subsys_ContinousContorl/src/MpcControle.cpp
  * @author  Richard Andrade
  * @version V1.0.0
  * @date    17-Nov-2015
  * @brief   LQR Controler estabilization.
  *****************************************************************************/

/* Includes ------------------------------------------------------------------*/
#include "LQRControler.h"
/* Private typedef -----------------------------------------------------------*/
using namespace Eigen;
using namespace TRAJECTORY;

//std::chrono::steady_clock::time_point last;
namespace LQR {
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
MatrixXf Ke(4,18);
MatrixXf auxu(4,1);
MatrixXf u(4,1);
MatrixXf ur(4,1);
MatrixXf deltaU(4,1);
MatrixXf xsi(2,1);
MatrixXf xsiant(2,1);
MatrixXf deltaxsi(2,1);
MatrixXf deltaxsiant(2,1);
MatrixXf xs(16,1);
MatrixXf deltaxs(16,1);
MatrixXf xr(16,1);
MatrixXf xs_aumented(18,1);
int nWSR;
float ts;
/* Exported functions definitions --------------------------------------------*/

LQRControler::LQRControler() {
	trajectory=new ReferenceTrajectory();
	Ke=Gain(2);
	deltaxsiant.setZero();
	xsiant.setZero();
	ts=0.012;
}

LQRControler::~LQRControler() {
	// TODO Auto-generated destructor stub
}

Eigen::MatrixXf LQRControler::Controler(Eigen::MatrixXf states,bool stop){

	if(stop){
		xs.setZero();
		xr.setZero();
		deltaxsi.setZero();
		xsi.setZero();
		xsiant.setZero();
		deltaxsi.setZero();
		deltaxsiant.setZero();
		deltaxs.setZero();
		xs_aumented.setZero();
		deltaxs.setZero();
		xsi.setZero();
		deltaU.setZero();
		xs_aumented.setZero();
		ur.setZero();
		auxu.setZero();
		ur.setZero();
		deltaU.setZero();
		xsiant.setZero();
		xsi.setZero();
		deltaxsiant.setZero();
		deltaxsi.setZero();
	}else{
		//Vectors of reference trajectory and control
		xs<<0,0,1,states.block(3,0,5,1),0,0,0,states.block(11,0,5,1);
		xr=trajectory->TrajetoryReference_LQR();

		//Vector integration of error(Trapezoidal method)
		deltaxsi<<xs(2,0)-xr(2,0),xs(5,0)-xr(5,0);
		xsi=xsiant+ts*(deltaxsi+deltaxsiant)/2;

		// Error state vector
		deltaxs=xs-xr;
		// augmented error state vector
		xs_aumented<<deltaxs,xsi;
		//Control action variation
		deltaU=Ke*xs_aumented;
		//Control reference
		ur<<9857.54,9837.48,0,0;
		// Total control action
		auxu=ur+deltaU;
		//Variable update
		xsiant=xsi;
		deltaxsiant=deltaxsi;
	}

	if(auxu(0,0)>15000 ){
		auxu(0,0)=15000;
	}
	if(auxu(1,0)>15000 ){
		auxu(1,0)=15000;
	}
	/*The mass in the mathematical model was taken in grams,
	for this reason the controller calculate the forces in g .m/s^2 and the torque in g .m^2/s^2.
	But, the actuators are in the international units N and N. m for this reason the controls
	actions are transforming from g to Kg*/
	u(0,0)=auxu(0,0)/1000;
	u(1,0)=auxu(1,0)/1000;
	u(2,0)=auxu(2,0)/1000;
	u(3,0)=auxu(3,0)/1000;

	return u;
}
/* Private functions ------------------------------------------------------- */

Eigen::MatrixXf LQRControler::Gain(int a){
	MatrixXf Ke(4,18);
	switch (a){
		case 1:
			Ke(0,0)=-0.042235;
			Ke(0,1)=-1.634000;
			Ke(0,2)=-214563.181606;
			Ke(0,3)=22361.316355;
			Ke(0,4)=-469.770928;
			Ke(0,5)=-44.429909;
			Ke(0,6)=-274.819725;
			Ke(0,7)=179.740442;
			Ke(0,8)=-4.138607;
			Ke(0,9)=-151.715469;
			Ke(0,10)=-27911.326194;
			Ke(0,11)=2639.419097;
			Ke(0,12)=-23.798532;
			Ke(0,13)=61.610643;
			Ke(0,14)=-2.455462;
			Ke(0,15)=1.722355;
			Ke(0,16)=-372525.858993;
			Ke(0,17)=-1340.343031;
			Ke(1,0)=0.043724;
			Ke(1,1)=1.634345;
			Ke(1,2)=-214913.758823;
			Ke(1,3)=-22361.035830;
			Ke(1,4)=491.422872;
			Ke(1,5)=51.523958;
			Ke(1,6)=273.003374;
			Ke(1,7)=-184.352417;
			Ke(1,8)=4.274720;
			Ke(1,9)=151.747531;
			Ke(1,10)=-27904.199336;
			Ke(1,11)=-2630.232262;
			Ke(1,12)=27.598384;
			Ke(1,13)=-60.585039;
			Ke(1,14)=2.419234;
			Ke(1,15)=-1.787794;
			Ke(1,16)=-373581.800483;
			Ke(1,17)=1361.641991;
			Ke(2,0)=-0.032541;
			Ke(2,1)=0.001419;
			Ke(2,2)=-0.994879;
			Ke(2,3)=-23.208702;
			Ke(2,4)=-473.620715;
			Ke(2,5)=-839.879509;
			Ke(2,6)=-711.719411;
			Ke(2,7)=-20.867705;
			Ke(2,8)=-2.984666;
			Ke(2,9)=0.125815;
			Ke(2,10)=-0.070789;
			Ke(2,11)=-5.393054;
			Ke(2,12)=-76.503440;
			Ke(2,13)=-127.230151;
			Ke(2,14)=-16.021031;
			Ke(2,15)=-1.140229;
			Ke(2,16)=-2.130183;
			Ke(2,17)=-2398.132818;
			Ke(3,0)=-0.021214;
			Ke(3,1)=-0.000183;
			Ke(3,2)=-0.378851;
			Ke(3,3)=1.199515;
			Ke(3,4)=-310.105790;
			Ke(3,5)=574.890920;
			Ke(3,6)=-0.508882;
			Ke(3,7)=-513.578256;
			Ke(3,8)=-1.946745;
			Ke(3,9)=-0.021392;
			Ke(3,10)=-0.026145;
			Ke(3,11)=0.612819;
			Ke(3,12)=-51.518510;
			Ke(3,13)=89.089725;
			Ke(3,14)=-0.597915;
			Ke(3,15)=-13.133928;
			Ke(3,16)=-0.818184;
			Ke(3,17)=1624.536393;
			break;
		case 2:
			Ke(0,0)=-0.030988;
			Ke(0,1)=-1.984245;
			Ke(0,2)=-195799.395454;
			Ke(0,3)=11891.295377;
			Ke(0,4)=-180.876571;
			Ke(0,5)=-1536.663662;
			Ke(0,6)=-245.416213;
			Ke(0,7)=165.890329;
			Ke(0,8)=-1.743738;
			Ke(0,9)=-110.745970;
			Ke(0,10)=-29199.714836;
			Ke(0,11)=1961.913398;
			Ke(0,12)=-14.716127;
			Ke(0,13)=-0.315128;
			Ke(0,14)=-2.388003;
			Ke(0,15)=1.261692;
			Ke(0,16)=-376404.568417;
			Ke(0,17)=-6400.497123;
			Ke(1,0)=0.034637;
			Ke(1,1)=1.976637;
			Ke(1,2)=-196277.629306;
			Ke(1,3)=-11846.000887;
			Ke(1,4)=201.784531;
			Ke(1,5)=1556.314812;
			Ke(1,6)=244.191889;
			Ke(1,7)=-170.779913;
			Ke(1,8)=1.948502;
			Ke(1,9)=110.337269;
			Ke(1,10)=-29213.951294;
			Ke(1,11)=-1948.095360;
			Ke(1,12)=18.982996;
			Ke(1,13)=2.228037;
			Ke(1,14)=2.367666;
			Ke(1,15)=-1.338513;
			Ke(1,16)=-377983.474813;
			Ke(1,17)=6454.109148;
			Ke(2,0)=-0.047378;
			Ke(2,1)=0.004004;
			Ke(2,2)=-1.851807;
			Ke(2,3)=-24.594792;
			Ke(2,4)=-272.759244;
			Ke(2,5)=-1726.758057;
			Ke(2,6)=-604.991888;
			Ke(2,7)=105.284974;
			Ke(2,8)=-2.670061;
			Ke(2,9)=0.224168;
			Ke(2,10)=-0.150263;
			Ke(2,11)=-5.076435;
			Ke(2,12)=-47.269575;
			Ke(2,13)=-180.121215;
			Ke(2,14)=-14.019100;
			Ke(2,15)=0.303278;
			Ke(2,16)=-4.794292;
			Ke(2,17)=-4676.061898;
			Ke(3,0)=-0.047517;
			Ke(3,1)=-0.002203;
			Ke(3,2)=-1.245171;
			Ke(3,3)=13.599331;
			Ke(3,4)=-275.031481;
			Ke(3,5)=1748.428079;
			Ke(3,6)=108.705176;
			Ke(3,7)=-612.052754;
			Ke(3,8)=-2.678528;
			Ke(3,9)=-0.123971;
			Ke(3,10)=-0.111721;
			Ke(3,11)=2.506000;
			Ke(3,12)=-47.593811;
			Ke(3,13)=182.225858;
			Ke(3,14)=0.358147;
			Ke(3,15)=-14.099505;
			Ke(3,16)=-3.011545;
			Ke(3,17)=4747.620655;
			break;
		case 3:
			//com 3
			Ke(0,0)=-0.080829;
			Ke(0,1)=-5.309731;
			Ke(0,2)=-130933.698020;
			Ke(0,3)=8724.834696;
			Ke(0,4)=-127.379633;
			Ke(0,5)=536.030265;
			Ke(0,6)=-99.513510;
			Ke(0,7)=25.291980;
			Ke(0,8)=-2.236354;
			Ke(0,9)=-147.719043;
			Ke(0,10)=-22148.390986;
			Ke(0,11)=1642.855172;
			Ke(0,12)=-12.027508;
			Ke(0,13)=120.171557;
			Ke(0,14)=-1.258463;
			Ke(0,15)=0.229415;
			Ke(0,16)=-260174.905754;
			Ke(0,17)=1174.226069;
			Ke(1,0)=0.089752;
			Ke(1,1)=5.298117;
			Ke(1,2)=-131205.510767;
			Ke(1,3)=-8703.718759;
			Ke(1,4)=142.219443;
			Ke(1,5)=-532.957299;
			Ke(1,6)=98.110947;
			Ke(1,7)=-28.076862;
			Ke(1,8)=2.482613;
			Ke(1,9)=147.411979;
			Ke(1,10)=-22158.087323;
			Ke(1,11)=-1633.684367;
			Ke(1,12)=15.432614;
			Ke(1,13)=-119.531598;
			Ke(1,14)=1.232679;
			Ke(1,15)=-0.270207;
			Ke(1,16)=-260915.479504;
			Ke(1,17)=-1167.950115;
			Ke(2,0)=-0.104319;
			Ke(2,1)=0.003929;
			Ke(2,2)=-0.854183;
			Ke(2,3)=-7.072851;
			Ke(2,4)=-169.614924;
			Ke(2,5)=-458.141057;
			Ke(2,6)=-379.761306;
			Ke(2,7)=22.373007;
			Ke(2,8)=-2.896085;
			Ke(2,9)=0.109982;
			Ke(2,10)=-0.077868;
			Ke(2,11)=-2.350308;
			Ke(2,12)=-31.078211;
			Ke(2,13)=-69.238219;
			Ke(2,14)=-11.293648;
			Ke(2,15)=-0.179669;
			Ke(2,16)=-2.143388;
			Ke(2,17)=-1389.245991;
			Ke(3,0)=-0.104193;
			Ke(3,1)=-0.000307;
			Ke(3,2)=-0.790902;
			Ke(3,3)=0.956714;
			Ke(3,4)=-170.364537;
			Ke(3,5)=457.432371;
			Ke(3,6)=22.025686;
			Ke(3,7)=-380.575027;
			Ke(3,8)=-2.894197;
			Ke(3,9)=-0.008608;
			Ke(3,10)=-0.084448;
			Ke(3,11)=0.754968;
			Ke(3,12)=-31.281377;
			Ke(3,13)=69.020719;
			Ke(3,14)=-0.191446;
			Ke(3,15)=-11.323067;
			Ke(3,16)=-1.726190;
			Ke(3,17)=1389.728564;
			break;
		case 4:
			//lambda=[1 1 45 200].*[1/(17000-freq),1/(17000-fleq),1/2000,1/2000].^2;
			//rho=5*[0,0,10,1/((pi/2)^2),1/((pi/2)^2),1/(pi)^2,1/((pi/2)^2),1/((pi/2)^2) 0 0 0 0 0 0 0 0 50 50/(pi)^2];
			Ke(0,0)=-0.032295;
			Ke(0,1)=-2.016175;
			Ke(0,2)=-157928.147851;
			Ke(0,3)=10552.471976;
			Ke(0,4)=-165.972685;
			Ke(0,5)=429.913504;
			Ke(0,6)=-138.743785;
			Ke(0,7)=70.829761;
			Ke(0,8)=-1.747596;
			Ke(0,9)=-109.787483;
			Ke(0,10)=-23913.729642;
			Ke(0,11)=1796.059902;
			Ke(0,12)=-14.652006;
			Ke(0,13)=104.884121;
			Ke(0,14)=-1.591144;
			Ke(0,15)=0.995191;
			Ke(0,16)=-359957.353471;
			Ke(0,17)=847.336401;
			Ke(1,0)=0.035245;
			Ke(1,1)=2.011899;
			Ke(1,2)=-158240.761665;
			Ke(1,3)=-10526.835553;
			Ke(1,4)=181.768253;
			Ke(1,5)=-424.144487;
			Ke(1,6)=137.069069;
			Ke(1,7)=-75.136548;
			Ke(1,8)=1.908084;
			Ke(1,9)=109.556632;
			Ke(1,10)=-23923.011184;
			Ke(1,11)=-1786.159987;
			Ke(1,12)=18.064892;
			Ke(1,13)=-103.913662;
			Ke(1,14)=1.557226;
			Ke(1,15)=-1.062437;
			Ke(1,16)=-360890.008113;
			Ke(1,17)=-831.768147;
			Ke(2,0)=-0.037970;
			Ke(2,1)=0.001720;
			Ke(2,2)=-0.962302;
			Ke(2,3)=-9.610004;
			Ke(2,4)=-199.237080;
			Ke(2,5)=-557.215150;
			Ke(2,6)=-438.775092;
			Ke(2,7)=27.722767;
			Ke(2,8)=-2.071055;
			Ke(2,9)=0.094127;
			Ke(2,10)=-0.083255;
			Ke(2,11)=-2.868384;
			Ke(2,12)=-36.393485;
			Ke(2,13)=-83.399759;
			Ke(2,14)=-12.175295;
			Ke(2,15)=-0.197003;
			Ke(2,16)=-2.643100;
			Ke(2,17)=-1733.014408;
			Ke(3,0)=-0.024662;
			Ke(3,1)=-0.000264;
			Ke(3,2)=-0.496740;
			Ke(3,3)=1.766074;
			Ke(3,4)=-130.358579;
			Ke(3,5)=388.837247;
			Ke(3,6)=25.631259;
			Ke(3,7)=-319.360004;
			Ke(3,8)=-1.345271;
			Ke(3,9)=-0.014483;
			Ke(3,10)=-0.050451;
			Ke(3,11)=0.711740;
			Ke(3,12)=-25.067799;
			Ke(3,13)=58.885303;
			Ke(3,14)=-0.046082;
			Ke(3,15)=-10.042757;
			Ke(3,16)=-1.171807;
			Ke(3,17)=1204.870709;
			break;
		default:
			Ke.setZero();
			break;
	}
	return Ke;
}
} /* namespace mpc */
